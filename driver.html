<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Giorizz Driver</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        giorizz: { green: '#00382B', gold: '#C5A065', bg: '#F4F4F5' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f4f4f5; display: flex; justify-content: center; min-height: 100vh; }
        .app-frame { width: 100%; max-width: 450px; background: white; position: relative; display: flex; flex-direction: column; height: 100vh; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .pulse-ring { animation: pulse-green 2s infinite; }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(0, 56, 43, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(0, 56, 43, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 56, 43, 0); }
        }
    </style>
</head>
<body>

<div class="app-frame">
    
    <div class="bg-white border-b border-zinc-100 p-4 flex justify-between items-center z-10">
        <span class="text-xl font-extrabold tracking-widest text-giorizz-green">GIORIZZ</span>
        <button id="onlineBtn" onclick="toggleOnline()" class="flex items-center space-x-2 text-[10px] font-bold border px-4 py-2 rounded-full transition-all bg-zinc-100 text-zinc-500">
            <i data-lucide="power" class="w-3 h-3"></i>
            <span id="onlineText">VAI ONLINE</span>
        </button>
    </div>

    <div id="searchingView" class="flex-1 flex flex-col items-center justify-center p-6 text-center" style="display:none;">
        <div class="w-32 h-32 rounded-full bg-emerald-50 flex items-center justify-center mb-6 relative">
            <div class="absolute inset-0 rounded-full border-4 border-emerald-100 animate-ping"></div>
            <i data-lucide="radar" class="w-12 h-12 text-giorizz-green"></i>
        </div>
        <h2 class="text-lg font-bold text-zinc-800">Ricerca Corse...</h2>
        <p class="text-xs text-zinc-400 mt-2">Rimani in questa schermata.<br>La prioritÃ  Ã¨ assegnata a te.</p>
    </div>

    <div id="offlineView" class="flex-1 flex flex-col items-center justify-center p-6 text-center">
        <div class="w-24 h-24 rounded-full bg-zinc-100 flex items-center justify-center mb-4">
            <i data-lucide="coffee" class="w-10 h-10 text-zinc-400"></i>
        </div>
        <h2 class="text-lg font-bold text-zinc-400">Sei Offline</h2>
        <p class="text-xs text-zinc-400 mt-2">Vai Online per ricevere richieste.</p>
    </div>

    <div id="jobCard" class="hidden absolute inset-0 bg-white z-50 flex flex-col">
        <div class="bg-giorizz-green p-6 text-white pb-10">
            <div class="text-xs font-bold opacity-70 uppercase mb-1">Nuova Richiesta</div>
            <div class="text-3xl font-bold">â‚¬ <span id="jobPrice">---</span></div>
            <div class="flex gap-2 mt-4">
                <span class="bg-white/20 px-2 py-1 rounded text-[10px] font-bold" id="jobVehicle">BUSINESS</span>
                <span class="bg-white/20 px-2 py-1 rounded text-[10px] font-bold">VIP CLIENT</span>
            </div>
        </div>
        
        <div class="flex-1 p-6 -mt-6 bg-white rounded-t-3xl overflow-y-auto">
            <div class="pl-4 border-l-2 border-zinc-100 space-y-8 relative">
                <div class="relative pl-6">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-giorizz-green ring-4 ring-green-50"></div>
                    <div class="text-xs font-bold text-zinc-400 mb-1">RITIRO</div>
                    <div id="jobPickup" class="text-lg font-bold text-zinc-900 leading-tight">---</div>
                </div>
                <div class="relative pl-6">
                    <div class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-giorizz-gold"></div>
                    <div class="text-xs font-bold text-zinc-400 mb-1">DESTINAZIONE</div>
                    <div id="jobDropoff" class="text-lg font-bold text-zinc-900 leading-tight">---</div>
                </div>
            </div>

            <div class="mt-10 grid grid-cols-2 gap-4">
                <div class="bg-zinc-50 p-4 rounded-xl text-center">
                    <div class="text-xs text-zinc-400 font-bold uppercase">Distanza</div>
                    <div class="font-bold text-zinc-800 mt-1">2.4 km</div>
                </div>
                <div class="bg-zinc-50 p-4 rounded-xl text-center">
                    <div class="text-xs text-zinc-400 font-bold uppercase">Tempo</div>
                    <div class="font-bold text-zinc-800 mt-1">8 min</div>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-zinc-100 flex gap-4">
            <button onclick="rejectJob()" class="flex-1 py-4 rounded-xl font-bold text-zinc-400 bg-zinc-100">RIFIUTA</button>
            <button onclick="acceptJob()" class="flex-[2] py-4 rounded-xl font-bold text-white bg-giorizz-green shadow-xl pulse-ring">ACCETTA</button>
        </div>
    </div>

</div>

<script>
    lucide.createIcons();

    // --- I TUOI DATI VERI ---
    const SUPABASE_URL = 'https://ysgebcbptgjlpbgnlcjt.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_vWLK2XVCNfki5wrkDEpBCQ_XCsjERhe';
    
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let isOnline = false;
    let intervalId = null;
    let currentJobId = null;

    function toggleOnline() {
        isOnline = !isOnline;
        const btn = document.getElementById('onlineBtn');
        const txt = document.getElementById('onlineText');
        const offView = document.getElementById('offlineView');
        const searchView = document.getElementById('searchingView');

        if (isOnline) {
            // GO ONLINE
            btn.classList.remove('bg-zinc-100', 'text-zinc-500');
            btn.classList.add('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
            txt.innerText = "SEI ONLINE";
            offView.style.display = 'none';
            searchView.style.display = 'flex';
            
            // Inizia a cercare nel database ogni 2 secondi
            checkForRides();
            intervalId = setInterval(checkForRides, 2000);
        } else {
            // GO OFFLINE
            btn.classList.add('bg-zinc-100', 'text-zinc-500');
            btn.classList.remove('bg-emerald-100', 'text-emerald-700', 'border-emerald-200');
            txt.innerText = "VAI ONLINE";
            offView.style.display = 'flex';
            searchView.style.display = 'none';
            document.getElementById('jobCard').classList.add('hidden');
            
            clearInterval(intervalId);
        }
    }

    async function checkForRides() {
        if (!isOnline) return;

        // CHIEDI AL DATABASE: "C'Ã¨ qualcuno che aspetta?"
        const { data, error } = await db
            .from('bookings')
            .select('*')
            .eq('status', 'pending') // Solo corse in attesa
            .limit(1); // Prendine una sola

        if (data && data.length > 0) {
            // TROVATA!
            const job = data[0];
            showJobCard(job);
        }
    }

    function showJobCard(job) {
        clearInterval(intervalId); // Smetti di cercare mentre decidi
        currentJobId = job.id;

        // RIEMPI I DATI
        document.getElementById('jobPrice').innerText = job.price;
        document.getElementById('jobVehicle').innerText = job.vehicle_type.toUpperCase();
        document.getElementById('jobPickup').innerText = job.pickup_address;
        document.getElementById('jobDropoff').innerText = job.dropoff_address;

        // MOSTRA LA SCHERMATA
        document.getElementById('jobCard').classList.remove('hidden');
        
        // VIBRAZIONE (Se su mobile)
        if(navigator.vibrate) navigator.vibrate([500, 200, 500]);
    }

    async function acceptJob() {
        // AGGIORNA DATABASE: "Presa!"
        const { error } = await db
            .from('bookings')
            .update({ status: 'assigned' })
            .eq('id', currentJobId);

        if (!error) {
            alert("CORSA ACCETTATA! âœ…\nNavigazione avviata...");
            // Qui in futuro metteremo la schermata di navigazione
            document.getElementById('jobCard').innerHTML = '<div class="flex-1 flex items-center justify-center font-bold text-xl">BUON VIAGGIO! ðŸš—</div>';
        }
    }

    function rejectJob() {
        document.getElementById('jobCard').classList.add('hidden');
        // Ricomincia a cercare
        intervalId = setInterval(checkForRides, 2000);
    }

</script>
</body>
</html>
